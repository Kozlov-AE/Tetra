<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Segoe UI,sans-serif'; font-size:24pt; font-weight:600; color:#000000;">Как найти и заменить текст в части документа (Open XML SDK)</span> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">В этом разделе показано, как использовать классы в Пакет Open XML SDK 2.5 для Office, чтобы программными средствами найти и заменить текстовое значение в документе Word.</span> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">Для компиляции кода, представленного в этом разделе, требуются следующие директивы сборки.</span> </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">    using System.IO; </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">    using System.Text.RegularExpressions; </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">    using DocumentFormat.OpenXml.Packaging; </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Segoe UI,sans-serif'; font-size:18pt; font-weight:600; color:#000000;">Пакеты и части документа</span> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">Документ Open XML хранится в виде пакета, формат которого определяется спецификацией </span><a href="https://www.iso.org/standard/71691.html"><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; text-decoration: underline; color:#0000ff;">ISO/IEC 29500-2</span></a><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">. Пакет может состоять из нескольких частей со связями между ними. Связь между частями определяет категорию документа. Документ может быть определен как текстовый документ, если его элемент связи пакета содержит связь с основной частью документа. Если соответствующий элемент содержит связь с частью презентации, он может быть определен как презентация. Если соответствующий элемент содержит связь с частью книги, он определяется как электронная таблица. В этот разделе вы будете использовать пакет текстового документа.</span> </p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Segoe UI,sans-serif'; font-size:18pt; font-weight:600; color:#000000;">Получение объекта WordprocessingDocument</span> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">В примере кода сначала откройте файл обработки текстов, создав экземпляр класса </span><a href="https://msdn.microsoft.com/ru-RU/library/office/documentformat.openxml.packaging.wordprocessingdocument.aspx"><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-weight:600; text-decoration: underline; color:#0000ff;">WordprocessingDocument</span></a><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">, как показано в следующем операторе </span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-weight:600; color:#000000;">using</span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">. В том же операторе откройте текстовый файл </span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-style:italic; color:#000000;">document</span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">, используя метод </span><a href="https://msdn.microsoft.com/ru-RU/library/office/cc562234.aspx"><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-weight:600; text-decoration: underline; color:#0000ff;">Open</span></a><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;"> и задав для логического параметра значение </span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-weight:600; color:#000000;">true</span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">, чтобы разрешить редактирование документа.</span> </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">    using (WordprocessingDocument wordDoc = </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">            WordprocessingDocument.Open(document, true)) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">    { </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">        // Insert other code here. </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">    } </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">Оператор </span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-weight:600; color:#000000;">using</span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;"> — это рекомендуемая альтернатива последовательности методов .Open, .Save, .Close. Это гарантирует, что метод </span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-weight:600; color:#000000;">Dispose</span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;"> (внутренний метод, используемый Open XML SDK для очистки ресурсов) вызывается автоматически при достижении закрывающей фигурной скобки. Блок, который следует за оператором </span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-weight:600; color:#000000;">using</span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">, устанавливает область объекта, создаваемого или именуемого в операторе </span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-weight:600; color:#000000;">using</span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">. В этом случае это </span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-style:italic; color:#000000;">wordDoc</span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">. Так как класс </span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-weight:600; color:#000000;">WordprocessingDocument</span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;"> в пакете Open XML SDK автоматически сохраняет и закрывает объект в реализации метода </span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-weight:600; color:#000000;">System.IDisposable</span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;"> и поскольку </span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-weight:600; color:#000000;">Dispose</span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;"> вызывается автоматически при выходе из блока, нет необходимости явно вызывать методы </span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-weight:600; color:#000000;">Save</span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;"> и </span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-weight:600; color:#000000;">Close</span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">, если вы используете оператор </span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-weight:600; color:#000000;">using</span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">.</span> </p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Segoe UI,sans-serif'; font-size:18pt; font-weight:600; color:#000000;">Как работает пример кода</span> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">После открытия файла для редактирования его можно прочитать с помощью объекта </span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-weight:600; color:#000000;">StreamReader</span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">.</span> </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">    using (StreamReader sr = new StreamReader(wordDoc.MainDocumentPart.GetStream())) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">    { </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">        docText = sr.ReadToEnd(); </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">    } </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">Затем код создает объект регулярного выражения, содержащий строку &quot;Hello world!&quot;. После этого текстовое значение заменяется на текст &quot;Hi Everyone!&quot;. Дополнительные сведения о регулярных выражениях см. в статье </span><a href="http://msdn.microsoft.com/ru-RU/library/hs600312.aspx"><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; text-decoration: underline; color:#0000ff;">Регулярные выражения</span></a> </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">    Regex regexText = new Regex(&quot;Hello world!&quot;); </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">    docText = regexText.Replace(docText, &quot;Hi Everyone!&quot;); </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">В следующем примере показан быстрый и простой способ поиска и замены. Он может оказаться не вполне надежным, поскольку извлекает документ XML в строчном формате. Используя регулярное выражение, вы можете случайно заменить XML-теги и повредить документ. Если вы хотите просто выполнить поиск в документе, не заменяя его содержимого, используйте </span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-style:italic; color:#000000;">MainDocumentPart.Document.InnerText</span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">.</span> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">В следующем примере также показано, как использовать регулярное выражение для поиска и замены текстового значения &quot;Hello world!&quot;, которое хранится в текстовом файле с именем &quot;MyPkg8.docx&quot;, на значение &quot;Hi Everyone!&quot;. Для вызова метода </span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; font-weight:600; color:#000000;">SearchAndReplace</span><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;"> можно использовать приведенный ниже пример.</span> </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">    SearchAndReplace(@&quot;C:\Users\Public\Documents\MyPkg8.docx&quot;); </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">После запуска программы вы можете просмотреть файл, чтобы увидеть измененный текст &quot;Hello world!&quot;.</span> </p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Segoe UI,sans-serif'; font-size:12pt; color:#000000;">Далее представлен полный пример кода на языке C#</span> </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">    // To search and replace content in a document part. </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">    public static void SearchAndReplace(string document) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">    { </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">        using (WordprocessingDocument wordDoc = WordprocessingDocument.Open(document, true)) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">        { </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">            string docText = null; </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">            using (StreamReader sr = new StreamReader(wordDoc.MainDocumentPart.GetStream())) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">            { </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">                docText = sr.ReadToEnd(); </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">            } </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">            Regex regexText = new Regex(&quot;Hello world!&quot;); </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">            docText = regexText.Replace(docText, &quot;Hi Everyone!&quot;); </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">            using (StreamWriter sw = new StreamWriter(wordDoc.MainDocumentPart.GetStream(FileMode.Create))) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">            { </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">                sw.Write(docText); </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">            } </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">        } </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#6a1009;">    } </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">  </p></body></html>